[支付系统设计：对账处理（二）](http://www.woshipm.com/it/459445.html)

可以说，对账是支付系统最头疼的事情。每一笔交易，都要做到各参与者的记录能够吻合，没有偏差。对账系统的工作，是发现有差异的记录，即**轧帐**；然后通过人工或者自动的方式，解决这些差异，即**平帐**。


对电商系统来说，每一笔交易，在所有相关主体侧都要能对得上：
* 交易主体，如果发起人是个人，必须能够从个人交易历史记录中找到这笔交易。但大部分人不会保留电子记录，所以一般是提供可以下载的账单或交易记录，让用户自己对去。
* 交易对手，一般是商户。商户侧对账处理同用户侧，也仅仅提供对账单。
* 交易渠道侧，这是对账的重点，**一是核实交易流水，二是核实交易佣金**，毕竟是租用人家通道做结算的。

对账处理流程
一般来说，对账流程涉及到如下步骤： 渠道对账单下载、本地交易记录准备、轧账、平账。
###渠道对账单下载
银行，第三方支付，银联等，基本都会提供对账单下载的功能。不过也有少数工作做不到位或者太到位的银行，只提供账单查询后台，不提供对账单下载功能。
对开发人员来说，这里有几个坑：

* 对账单格式不一。文本，XML，csv的都有。为了后续能够统一处理，在账单下载完成后，需要进行标准化处理。
* 下载方式不一，HTTP，HTTPS，FTP的，都有。下载程序需要按照渠道的协议来处理。
* 下载时间不一，一般是凌晨1点后，到中午12才能用的也有。如果在预定的时间取不到数据，需要注意重试读取。
* 稳定性差。FTP服务器出问题那是常有的事。渠道侧解决方案往往就是重启。所以重试机制是必要的。

看一下第三方支付的对账单情况：
![](http://image.woshipm.com/wp-files/2016/11/RyBDSooI5fLy2O7uPpIa.png)
银行直连的对账情况：
![](http://image.woshipm.com/wp-files/2016/11/24wzd7thYO42rGvRZkWU.png)

技术选型上，HTTP(S)用apache httpclient即可实现链接池和断点续传， FTP也可以使用Apache Commons Net API。 但不管是哪一个，都需要设置重试次数和链接超时间。重试次数和间隔的设置需要小心，重试太频繁，容易把服务器打死.；时间间隔太大，又会阻塞后续处理步骤。5～10分钟是一个合适的重试间隔区间。

链接超时指在服务器出现问题时，连接在指定时间内获取不到数据即自动断开。这个很容易被忽略。我们有一次系统出问题，是渠道侧的FTP假死后重启，导致我们的客户端挂住，一直在等待重新链接。

###渠道对账单标准化
找个例子大家看看， 比如微信的对账单，他是csv格式的，包括如下信息：

* 交易时间：这是在微信侧的支付完成的时间。 这个时间会成为一个陷阱。
* 公众账号ID，商户号,子商户号,设备号： 这些信息需要做验证，确保是自己的单子，不要让微信把老王家的单子也给发过来了；
* 微信订单号,商户订单号： 这两个是对单的核心。前者是微信侧产生的订单号，在微信支付接口返回值中有。但是万一收不到这个返回值，那在本地记录中可能就空了。 后者是我们发送给微信的订单号，一般用这个来做对单依据。两边的数据中都会有这个值。
* 用户标识,交易类型,交易状态,付款银行,货币种类,总金额,企业红包金额： 这几个就是对单的核心字段，必须确保双方是一致的。
* 商品名称,商户数据包,手续费,费率：这些是可选验证。
![](http://image.woshipm.com/wp-files/2016/11/SB6KzCBywJyDVakKgK64.png)

而某宝的对账单，是文本格式的，用空格隔开。他们家的就简单很多，只有商户订单号，交易流水号，交易时间，支付时间，付款方，交易金额，交易类型，交易状态这些字段。
![](http://image.woshipm.com/wp-files/2016/11/HrYwH8VBZwuD6NrELWPh.png)
由于每个渠道的账单格式都不尽相同， 在得到账单后，下一步是对账单做标准化处理，这样轧帐以及后续工作就可以统一处理了。 标准化后的账单数据可以放在文件系统或者数据库中。这取决于交易数据量。每天百万以上的量，还是使用文件系统，比较合适。数据库操作相对比较慢，也浪费资源。
基于文件系统的标准化涉及如下内容：

* 文件格式标准化：统一使用csv或者json或者xml格式。如果是使用hadoop或者spark来对账，使用csv是个不错的选择。
* 文件存储统一化：文件目录，文件名都需要遵循统一命名规范。
为了加快处理速度，我们使用hdfs作为文件系统，有利于后续的对账的处理。



###本地交易记录准备














